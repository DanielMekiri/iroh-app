<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>iroH</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Roboto:wght@300;400;700&display=swap');
    body { overscroll-behavior: none; -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; font-family: 'Roboto', sans-serif; }
    .bauhaus-title { font-family: 'Bebas Neue', sans-serif; letter-spacing: 0.05em; }
    .bauhaus-card { border: 3px solid #000; box-shadow: 8px 8px 0px #000; }
    .bauhaus-btn { border: 3px solid #000; transition: all 0.2s; font-weight: 700; text-transform: uppercase; }
    .bauhaus-btn:active { transform: translate(4px, 4px); box-shadow: none; }
    .recording-pulse { animation: pulse 1s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .geometric-circle { clip-path: circle(50%); }
    .iroh-logo { font-family: 'Bebas Neue', sans-serif; letter-spacing: 0.05em; }
    .iroh-logo .lower { text-transform: lowercase; }
    .iroh-logo .upper { text-transform: uppercase; }
  </style>
</head>
<body class="bg-white min-h-screen">
  <div id="app"></div>
  <script>
    let state = {
      screen: 'setup',
      myProfile: JSON.parse(localStorage.getItem('iroh_profile') || 'null'),
      contacts: JSON.parse(localStorage.getItem('iroh_contacts') || '[]'),
      isListening: JSON.parse(localStorage.getItem('iroh_listening') || 'true'),
      isMuted: false,
      isSpeakerOn: true,
      currentCall: null,
      incomingCall: null,
      incomingAudioQueue: [],
      settings: JSON.parse(localStorage.getItem('iroh_settings') || '{"notifyOnSilent":true,"yesCommand":null}'),
      showAddContact: false,
      showEditProfile: false,
      showListeningConfirm: false,
      newContact: { name: '', photo: null },
      currentTranscript: '',
      pendingDelete: null,
      lastSpeechTime: 0,
      silenceTimer: null,
      speechHistory: []
    };
    let recognition = null;
    let mediaRecorder = null;
    let audioChunks = [];
    let isCapturingCall = false;
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.continuous = true;
      recognition.interimResults = true;
      recognition.onresult = (event) => {
        const last = event.results.length - 1;
        const text = event.results[last][0].transcript.toLowerCase().trim();
        state.currentTranscript = text;
        state.lastSpeechTime = Date.now();
        state.speechHistory.push({ text: text, time: Date.now() });
        state.speechHistory = state.speechHistory.filter(s => Date.now() - s.time < 10000);
        render();
        handleVoiceCommand(text);
        if (state.currentCall) { resetSilenceTimer(); }
      };
      recognition.onerror = (event) => {
        console.error('Speech recognition error:', event.error);
        if (event.error === 'no-speech') {
          setTimeout(() => { if (state.isListening) { try { recognition.start(); } catch(e) {} } }, 1000);
        }
      };
      recognition.onend = () => { if (state.isListening) { try { recognition.start(); } catch(e) {} } };
    }
    if (recognition && state.myProfile && state.isListening) { try { recognition.start(); } catch(e) {} }
    function resetSilenceTimer() {
      if (state.silenceTimer) { clearTimeout(state.silenceTimer); }
      state.silenceTimer = setTimeout(() => {
        if (state.currentCall) {
          alert('Call ended due to 30 seconds of silence');
          endCall();
        }
      }, 30000);
    }
    function toggleListening() {
      state.showListeningConfirm = true;
      render();
    }
    function confirmToggleListening(confirm) {
      if (confirm) {
        state.isListening = !state.isListening;
        localStorage.setItem('iroh_listening', JSON.stringify(state.isListening));
        if (state.isListening && recognition) {
          try { recognition.start(); } catch(e) {}
        } else if (recognition) {
          try { recognition.stop(); } catch(e) {}
        }
      }
      state.showListeningConfirm = false;
      render();
    }
    function isIsolatedWord(targetWord) {
      const now = Date.now();
      const recentSpeech = state.speechHistory.filter(s => now - s.time < 6000);
      if (recentSpeech.length === 0) return false;
      const targetIndex = recentSpeech.findIndex(s => s.text.includes(targetWord.toLowerCase()));
      if (targetIndex === -1) return false;
      const targetTime = recentSpeech[targetIndex].time;
      const before = recentSpeech.filter(s => s.time < targetTime && targetTime - s.time < 3000);
      const after = recentSpeech.filter(s => s.time > targetTime && s.time - targetTime < 3000);
      const beforeWords = before.map(s => s.text.split(' ')).flat().filter(w => w.length > 2);
      const afterWords = after.map(s => s.text.split(' ')).flat().filter(w => w.length > 2);
      return beforeWords.length === 0 && afterWords.length === 0;
    }
    function handleVoiceCommand(text) {
      if (state.incomingCall && state.settings.yesCommand) {
        const yesVariants = [state.settings.yesCommand.targetText.toLowerCase(), 'yes', 'yeah', 'yep'];
        if (yesVariants.some(v => text.includes(v))) { acceptCall(); return; }
      }
      if (state.screen === 'contacts' && !state.currentCall && !isCapturingCall) {
        for (const contact of state.contacts) {
          if (contact.isActive && contact.nameVariants) {
            for (const variant of contact.nameVariants) {
              if (text.includes(variant.toLowerCase()) && isIsolatedWord(variant)) {
                startRecordingForCall(contact);
                return;
              }
            }
          }
        }
      }
    }
    async function startRecordingForCall(contact) {
      try {
        isCapturingCall = true;
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        mediaRecorder.ondataavailable = (event) => { if (event.data.size > 0) { audioChunks.push(event.data); } };
        mediaRecorder.onstop = () => {
          const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
          const audioUrl = URL.createObjectURL(audioBlob);
          stream.getTracks().forEach(track => track.stop());
          if (state.incomingCall && state.incomingCall.id === contact.id) {
            state.incomingAudioQueue.push(audioUrl);
            playNextInQueue();
          } else {
            initiateCall(contact, audioUrl);
          }
          isCapturingCall = false;
        };
        mediaRecorder.start();
        setTimeout(() => { if (mediaRecorder && mediaRecorder.state === 'recording') { mediaRecorder.stop(); } }, 2500);
      } catch (error) {
        console.error('Recording error:', error);
        alert('Could not access microphone: ' + error.message);
        isCapturingCall = false;
      }
    }
    function playNextInQueue() {
      if (state.incomingAudioQueue.length > 0) {
        const audioUrl = state.incomingAudioQueue.shift();
        const audio = new Audio(audioUrl);
        audio.play();
        audio.onended = () => { if (state.incomingAudioQueue.length > 0) { setTimeout(() => playNextInQueue(), 500); } };
      }
    }
    function setupProfile(name, email, photoUrl) {
      state.myProfile = { name, email, photo: photoUrl };
      localStorage.setItem('iroh_profile', JSON.stringify(state.myProfile));
      state.screen = 'contacts';
      if (recognition && state.isListening) { try { recognition.start(); } catch(e) {} }
      render();
    }
    function updateProfile(name, email, photoUrl) {
      state.myProfile = { name, email, photo: photoUrl || state.myProfile.photo };
      localStorage.setItem('iroh_profile', JSON.stringify(state.myProfile));
      state.showEditProfile = false;
      render();
    }
    function addContact(name, photoUrl) {
      const nameVariants = generateNameVariants(name);
      const newContact = { id: Date.now(), name: name, photo: photoUrl, nameVariants: nameVariants, isActive: true };
      state.contacts.push(newContact);
      localStorage.setItem('iroh_contacts', JSON.stringify(state.contacts));
      state.showAddContact = false;
      sendInvite(name);
      render();
    }
    function generateNameVariants(name) {
      const variants = [name.toLowerCase()];
      const words = name.toLowerCase().split(' ');
      variants.push(...words);
      if (words.length > 1) {
        variants.push(words[0]);
        variants.push(words[words.length - 1]);
      }
      const nicknames = {
        'alexander': ['alex', 'al', 'xander'],
        'alexandra': ['alex', 'alexa', 'sandra'],
        'elizabeth': ['liz', 'beth', 'eliza', 'lizzy'],
        'michael': ['mike', 'mikey', 'mick'],
        'michelle': ['shell', 'shelly', 'mich'],
        'christopher': ['chris', 'topher'],
        'christina': ['chris', 'tina', 'christy'],
        'william': ['will', 'bill', 'billy', 'liam'],
        'robert': ['rob', 'bob', 'bobby'],
        'richard': ['rick', 'dick', 'richie'],
        'jennifer': ['jen', 'jenny', 'jenn'],
        'jonathan': ['jon', 'johnny'],
        'matthew': ['matt', 'matty'],
        'anthony': ['tony', 'ant'],
        'daniel': ['dan', 'danny'],
        'benjamin': ['ben', 'benji', 'benny'],
        'katherine': ['kate', 'kathy', 'katie', 'kat'],
        'nicholas': ['nick', 'nicky'],
        'samuel': ['sam', 'sammy'],
        'patricia': ['pat', 'patty', 'tricia']
      };
      const lowerName = name.toLowerCase();
      for (const [full, nicks] of Object.entries(nicknames)) {
        if (lowerName.includes(full)) {
          variants.push(...nicks);
        }
      }
      return [...new Set(variants)];
    }
    function confirmRemoveContact(id) {
      state.pendingDelete = id;
      render();
    }
    function removeContact(id) {
      state.contacts = state.contacts.filter(c => c.id !== id);
      localStorage.setItem('iroh_contacts', JSON.stringify(state.contacts));
      state.pendingDelete = null;
      render();
    }
    function toggleContactActive(id) {
      const contact = state.contacts.find(c => c.id === id);
      if (contact) {
        contact.isActive = !contact.isActive;
        localStorage.setItem('iroh_contacts', JSON.stringify(state.contacts));
        render();
      }
    }
    function initiateCall(contact, notificationAudio) {
      state.currentCall = contact;
      state.screen = 'call';
      state.isSpeakerOn = true;
      resetSilenceTimer();
      render();
    }
    function simulateIncomingCall(contact) {
      state.incomingCall = contact;
      state.incomingAudioQueue = [];
      state.screen = 'incoming';
      const utterance = new SpeechSynthesisUtterance(state.myProfile.name);
      utterance.rate = 0.9;
      speechSynthesis.speak(utterance);
      render();
    }
    function acceptCall() {
      state.currentCall = state.incomingCall;
      state.incomingCall = null;
      state.incomingAudioQueue = [];
      state.screen = 'call';
      state.isSpeakerOn = true;
      resetSilenceTimer();
      render();
    }
    function declineCall() {
      state.incomingCall = null;
      state.incomingAudioQueue = [];
      state.screen = 'contacts';
      render();
    }
    function endCall() {
      if (state.silenceTimer) { clearTimeout(state.silenceTimer); state.silenceTimer = null; }
      state.currentCall = null;
      state.screen = 'contacts';
      state.isMuted = false;
      state.isSpeakerOn = true;
      render();
    }
    function toggleSetting(key) { state.settings[key] = !state.settings[key]; localStorage.setItem('iroh_settings', JSON.stringify(state.settings)); render(); }
    function sendInvite(contactName) {
      const inviteLink = 'https://iroh-app-invite.com/' + btoa(state.myProfile.email);
      const appStoreLink = 'https://apps.apple.com/app/iroh';
      const subject = encodeURIComponent(state.myProfile.name + ' wants to connect on iroH');
      const body = encodeURIComponent('Hi ' + contactName + ',\n\n' + state.myProfile.name + ' invited you to connect on iroH - voice-first calling for your VIPs.\n\nClick here to connect: ' + inviteLink + '\n\nDon\'t have the app yet? Download it here:\niOS: ' + appStoreLink + '\n\nSee you on iroH!');
      window.location.href = 'mailto:?subject=' + subject + '&body=' + body;
    }
    function handleImageUpload(inputId, callback) {
      const input = document.getElementById(inputId);
      const file = input.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const maxSize = 800;
            let width = img.width;
            let height = img.height;
            if (width > height) {
              if (width > maxSize) { height *= maxSize / width; width = maxSize; }
            } else {
              if (height > maxSize) { width *= maxSize / height; height = maxSize; }
            }
            canvas.width = width;
            canvas.height = height;
            ctx.drawImage(img, 0, 0, width, height);
            callback(canvas.toDataURL('image/jpeg', 0.85));
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      }
    }
    function renderSetup() { return '<div class="min-h-screen flex items-center justify-center p-6 bg-yellow-400"><div class="bauhaus-card bg-white p-8 max-w-md w-full"><h1 class="text-6xl text-center mb-8"><span class="iroh-logo"><span class="lower">iro</span><span class="upper">H</span></span></h1><p class="text-center mb-6 text-gray-700">Set up your profile to start</p><input type="text" id="profileName" placeholder="Your Name" class="w-full p-4 border-3 border-black mb-4 text-lg"/><input type="email" id="profileEmail" placeholder="Your Email" class="w-full p-4 border-3 border-black mb-4 text-lg"/><div class="mb-6"><label class="bauhaus-btn bg-red-500 text-white p-4 block text-center cursor-pointer mb-2">Upload Photo (Optional)<input type="file" id="profilePhoto" accept="image/*" class="hidden"/></label><div id="photoPreview" class="text-center text-sm text-gray-600"></div></div><button onclick="createProfile()" class="bauhaus-btn bg-blue-600 text-white p-4 w-full" style="box-shadow: 6px 6px 0px #000;">Create Profile</button></div></div>'; }
    function renderContacts() {
      let html = '<div class="min-h-screen bg-yellow-400 p-4"><div class="max-w-md mx-auto"><div class="flex items-center justify-between mb-8"><h1 class="text-5xl"><span class="iroh-logo"><span class="lower">iro</span><span class="upper">H</span></span></h1><button onclick="state.screen=\'settings\'; render();" class="bauhaus-btn bg-white p-3" style="box-shadow: 4px 4px 0px #000;">‚öôÔ∏è</button></div>';
      if (state.myProfile) {
        html += '<div class="bauhaus-card bg-white p-4 mb-6"><div class="flex items-center gap-4">';
        if (state.myProfile.photo) { html += '<img src="' + state.myProfile.photo + '" class="w-16 h-16 geometric-circle border-3 border-black"/>'; } else { html += '<div class="w-16 h-16 geometric-circle bg-red-500 border-3 border-black"></div>'; }
        html += '<div class="flex-1"><p class="text-sm font-bold uppercase">Your Profile</p><p class="text-xl font-bold">' + state.myProfile.name + '</p></div><button onclick="state.showEditProfile=true; render();" class="bauhaus-btn bg-blue-500 text-white p-2 text-sm" style="box-shadow: 2px 2px 0px #000;">‚úèÔ∏è</button></div></div>';
      }
      html += '<div class="bauhaus-card bg-white p-4 mb-4"><div class="flex items-center justify-between"><span class="font-bold uppercase text-sm">Voice Control</span><button onclick="toggleListening()" class="bauhaus-btn ' + (state.isListening ? 'bg-green-500' : 'bg-red-500') + ' text-white p-2 text-xs" style="box-shadow: 2px 2px 0px #000;">' + (state.isListening ? 'ON' : 'OFF') + '</button></div>';
      if (state.isListening) {
        html += '<div class="mt-2 flex items-center gap-2"><div class="w-2 h-2 bg-green-500 rounded-full recording-pulse"></div><span class="text-xs text-gray-600">Listening...</span></div>';
        if (state.currentTranscript) { html += '<div class="mt-2 p-2 bg-gray-100 text-xs border-2 border-black">"' + state.currentTranscript + '"</div>'; }
      }
      html += '</div>';
      html += '<div class="flex items-center justify-between mb-4"><h2 class="bauhaus-title text-2xl">CONTACTS</h2><button onclick="state.showAddContact = true; render();" class="bauhaus-btn bg-red-500 text-white p-3" style="box-shadow: 4px 4px 0px #000;">‚ûï</button></div>';
      if (state.contacts.length === 0) { html += '<div class="bauhaus-card bg-white p-8 text-center"><p class="font-bold mb-2">No contacts yet</p><p class="text-sm text-gray-600">Add someone special</p></div>'; } else {
        html += '<div class="space-y-4">';
        state.contacts.forEach(contact => {
          html += '<div class="bauhaus-card bg-white p-4"><div class="flex items-center justify-between mb-3"><div class="flex items-center gap-3">';
          if (contact.photo) { html += '<img src="' + contact.photo + '" class="w-12 h-12 geometric-circle border-3 border-black"/>'; } else { html += '<div class="w-12 h-12 geometric-circle bg-blue-500 border-3 border-black"></div>'; }
          html += '<div><p class="font-bold text-lg">' + contact.name + '</p>';
          if (contact.nameVariants) { html += '<p class="text-xs text-gray-600">Say: ' + contact.nameVariants.slice(0, 2).join(', ') + '</p>'; }
          html += '</div></div><div class="flex gap-2"><button onclick="toggleContactActive(' + contact.id + ')" class="bauhaus-btn ' + (contact.isActive ? 'bg-green-500' : 'bg-gray-400') + ' text-white p-2 text-sm" style="box-shadow: 2px 2px 0px #000;">' + (contact.isActive ? 'üîî' : 'üîï') + '</button><button onclick="confirmRemoveContact(' + contact.id + ')" class="bauhaus-btn bg-red-500 text-white p-2 text-sm" style="box-shadow: 2px 2px 0px #000;">‚ùå</button></div></div>';
          html += '<button onclick=\'sendInvite("' + contact.name + '")\' class="bauhaus-btn bg-purple-500 text-white p-2 text-xs w-full mt-2" style="box-shadow: 2px 2px 0px #000;">üìß Send Invite</button>';
          html += '<button onclick=\'simulateIncomingCall(' + JSON.stringify(contact) + ')\' class="bauhaus-btn bg-yellow-300 p-2 text-xs w-full mt-2" style="box-shadow: 2px 2px 0px #000;">üì≤ Test Call</button></div>';
        });
        html += '</div>';
      }
      html += '</div></div>';
      if (state.showAddContact) { html += '<div class="fixed inset-0 bg-black/80 flex items-center justify-center p-6 z-50"><div class="bauhaus-card bg-white p-6 max-w-sm w-full"><h2 class="bauhaus-title text-3xl mb-4">Add Contact</h2><input type="text" id="contactName" placeholder="Contact Name" class="w-full p-3 border-3 border-black mb-4"/><label class="bauhaus-btn bg-blue-500 text-white p-3 block text-center cursor-pointer mb-4">Upload Photo (Optional)<input type="file" id="contactPhoto" accept="image/*" class="hidden"/></label><div class="bg-blue-50 border-2 border-blue-500 rounded p-3 mb-4 text-xs"><p class="font-bold mb-1">üí° Name Recognition Tips:</p><p>Use simple, common names for best results. The app will recognize variations automatically (e.g., "Alex" for Alexander).</p></div><div class="flex gap-2"><button onclick="state.showAddContact = false; render();" class="bauhaus-btn bg-gray-300 p-3 flex-1" style="box-shadow: 3px 3px 0px #000;">Cancel</button><button onclick="saveNewContact()" class="bauhaus-btn bg-red-500 text-white p-3 flex-1" style="box-shadow: 3px 3px 0px #000;">Add</button></div></div></div>'; }
      if (state.showEditProfile) { html += '<div class="fixed inset-0 bg-black/80 flex items-center justify-center p-6 z-50"><div class="bauhaus-card bg-white p-6 max-w-sm w-full"><h2 class="bauhaus-title text-3xl mb-4">Edit Profile</h2><input type="text" id="editName" placeholder="Your Name" value="' + state.myProfile.name + '" class="w-full p-3 border-3 border-black mb-4"/><input type="email" id="editEmail" placeholder="Your Email" value="' + (state.myProfile.email || '') + '" class="w-full p-3 border-3 border-black mb-4"/><label class="bauhaus-btn bg-blue-500 text-white p-3 block text-center cursor-pointer mb-4">Change Photo<input type="file" id="editPhoto" accept="image/*" class="hidden"/></label><div class="flex gap-2"><button onclick="state.showEditProfile = false; render();" class="bauhaus-btn bg-gray-300 p-3 flex-1" style="box-shadow: 3px 3px 0px #000;">Cancel</button><button onclick="saveProfileEdit()" class="bauhaus-btn bg-blue-600 text-white p-3 flex-1" style="box-shadow: 3px 3px 0px #000;">Save</button></div></div></div>'; }
      if (state.pendingDelete) { const contact = state.contacts.find(c => c.id === state.pendingDelete); html += '<div class="fixed inset-0 bg-black/80 flex items-center justify-center p-6 z-50"><div class="bauhaus-card bg-white p-6 max-w-sm w-full text-center"><h2 class="bauhaus-title text-2xl mb-4">Remove Contact?</h2><p class="mb-6">Permanently remove <strong>' + contact.name + '</strong>?</p><div class="flex gap-2"><button onclick="state.pendingDelete=null; render();" class="bauhaus-btn bg-gray-300 p-3 flex-1" style="box-shadow: 3px 3px 0px #000;">Keep</button><button onclick="removeContact(' + state.pendingDelete + ')" class="bauhaus-btn bg-red-600 text-white p-3 flex-1" style="box-shadow: 3px 3px 0px #000;">Remove</button></div></div></div>'; }
      if (state.showListeningConfirm) { html += '<div class="fixed inset-0 bg-black/80 flex items-center justify-center p-6 z-50"><div class="bauhaus-card bg-white p-6 max-w-sm w-full text-center"><h2 class="bauhaus-title text-2xl mb-4">Change Voice Control?</h2><p class="mb-6">Turn voice control <strong>' + (state.isListening ? 'OFF' : 'ON') + '</strong>?</p><div class="flex gap-2"><button onclick="confirmToggleListening(false)" class="bauhaus-btn bg-gray-300 p-3 flex-1" style="box-shadow: 3px 3px 0px #000;">Cancel</button><button onclick="confirmToggleListening(true)" class="bauhaus-btn bg-blue-600 text-white p-3 flex-1" style="box-shadow: 3px 3px 0px #000;">Confirm</button></div></div></div>'; }
      return html;
    }
    function renderIncoming() {
      let html = '<div class="min-h-screen bg-blue-600 flex items-center justify-center p-6"><div class="text-center max-w-sm text-white"><div class="bauhaus-card bg-white text-black p-8 mb-8">';
      if (state.incomingCall.photo) { html += '<img src="' + state.incomingCall.photo + '" class="w-32 h-32 mx-auto geometric-circle border-4 border-black mb-4 recording-pulse"/>'; } else { html += '<div class="w-32 h-32 mx-auto geometric-circle bg-yellow-400 border-4 border-black mb-4 recording-pulse"></div>'; }
      html += '<h2 class="bauhaus-title text-4xl mb-2">' + state.incomingCall.name + '</h2><p class="text-xl">is calling...</p></div>';
      html += '<div class="bauhaus-card bg-white text-black p-4 mb-6"><p class="font-bold">Say "yes" to answer</p>';
      if (state.currentTranscript) { html += '<p class="text-sm mt-2 text-gray-600">"' + state.currentTranscript + '"</p>'; }
      html += '</div><div class="flex gap-4 justify-center"><button onclick="declineCall()" class="bauhaus-btn bg-red-500 text-white p-6 text-3xl w-20 h-20 rounded-full" style="box-shadow: 6px 6px 0px #000;">‚ùå</button><button onclick="acceptCall()" class="bauhaus-btn bg-green-500 text-white p-6 text-3xl w-20 h-20 rounded-full" style="box-shadow: 6px 6px 0px #000;">‚úÖ</button></div></div></div>';
      return html;
    }
    function renderCall() {
      let html = '<div class="min-h-screen bg-green-500 flex flex-col items-center justify-between p-6"><div class="text-center mt-16"><div class="bauhaus-card bg-white text-black p-8">';
      if (state.currentCall.photo) { html += '<img src="' + state.currentCall.photo + '" class="w-32 h-32 mx-auto geometric-circle border-4 border-black mb-4"/>'; } else { html += '<div class="w-32 h-32 mx-auto geometric-circle bg-yellow-400 border-4 border-black mb-4"></div>'; }
      html += '<h2 class="bauhaus-title text-4xl mb-2">' + state.currentCall.name + '</h2><p class="text-xl font-bold text-green-600">Connected</p></div></div>';
      html += '<div class="w-full max-w-sm"><div class="bauhaus-card bg-white p-4 mb-6 text-center"><p class="text-sm font-bold mb-1">Call ends after 30s of silence</p>';
      if (state.currentTranscript) { html += '<p class="text-xs text-gray-600 mt-2">"' + state.currentTranscript + '"</p>'; }
      html += '</div><div class="flex gap-4 justify-center mb-6"><button onclick="state.isMuted = !state.isMuted; render();" class="bauhaus-btn ' + (state.isMuted ? 'bg-red-500' : 'bg-white') + ' p-6 text-3xl w-16 h-16" style="box-shadow: 4px 4px 0px #000;">' + (state.isMuted ? 'üîá' : 'üé§') + '</button><button onclick="state.isSpeakerOn = !state.isSpeakerOn; render();" class="bauhaus-btn ' + (state.isSpeakerOn ? 'bg-white' : 'bg-gray-300') + ' p-6 text-3xl w-16 h-16" style="box-shadow: 4px 4px 0px #000;">' + (state.isSpeakerOn ? 'üîä' : 'üîà') + '</button></div>';
      html += '<button onclick="endCall()" class="bauhaus-btn bg-red-600 text-white p-4 w-full text-xl font-bold" style="box-shadow: 6px 6px 0px #000;">‚ùå END CALL</button></div></div>';
      return html;
    }
    function renderSettings() {
      let html = '<div class="min-h-screen bg-yellow-400 p-6"><div class="max-w-md mx-auto"><div class="flex items-center mb-8"><button onclick="state.screen=\'contacts\'; render();" class="bauhaus-btn bg-white p-3 mr-4" style="box-shadow: 3px 3px 0px #000;">‚¨ÖÔ∏è</button><h1 class="bauhaus-title text-4xl">Settings</h1></div>';
      html += '<div class="space-y-4"><div class="bauhaus-card bg-white p-4"><div class="flex items-center justify-between mb-2"><div><p class="font-bold">Notify on Silent</p><p class="text-sm text-gray-600">Hear calls when phone is silent</p></div><button onclick="toggleSetting(\'notifyOnSilent\')" class="w-16 h-8 ' + (state.settings.notifyOnSilent ? 'bg-green-500' : 'bg-gray-400') + ' border-3 border-black relative"><div class="w-6 h-6 bg-white border-3 border-black absolute top-0.5 transition-all ' + (state.settings.notifyOnSilent ? 'right-0.5' : 'left-0.5') + '"></div></button></div></div>';
      html += '<div class="bauhaus-card bg-white p-4"><p class="font-bold mb-2">About iroH</p><p class="text-sm text-gray-700 mb-2">Voice-first calling for your VIPs</p><p class="text-xs text-gray-500 mb-3">Version 2.1 - Bauhaus Edition</p><div class="bg-blue-50 border-2 border-blue-500 rounded p-3 text-xs"><p class="font-bold mb-1">üì± Native App Features:</p><p>When converted to iOS/Android app, voice recognition will use on-device AI that truly learns your pronunciation for perfect accuracy.</p></div></div></div></div></div>';
      return html;
    }
    function render() {
      const app = document.getElementById('app');
      let html = '';
      switch (state.screen) {
        case 'setup': html = renderSetup(); break;
        case 'contacts': html = renderContacts(); break;
        case 'incoming': html = renderIncoming(); break;
        case 'call': html = renderCall(); break;
        case 'settings': html = renderSettings(); break;
      }
      app.innerHTML = html;
      setTimeout(() => {
        const profilePhoto = document.getElementById('profilePhoto');
        if (profilePhoto) { profilePhoto.onchange = () => handleImageUpload('profilePhoto', (url) => { document.getElementById('photoPreview').innerHTML = '‚úì Photo selected'; }); }
        const contactPhoto = document.getElementById('contactPhoto');
        if (contactPhoto) { contactPhoto.onchange = () => handleImageUpload('contactPhoto', () => {}); }
        const editPhoto = document.getElementById('editPhoto');
        if (editPhoto) { editPhoto.onchange = () => handleImageUpload('editPhoto', () => {}); }
      }, 0);
    }
    window.createProfile = function() {
      const name = document.getElementById('profileName').value;
      const email = document.getElementById('profileEmail').value;
      const photoInput = document.getElementById('profilePhoto');
      if (!name) { alert('Please enter your name'); return; }
      if (!email) { alert('Please enter your email'); return; }
      if (photoInput && photoInput.files && photoInput.files[0]) { handleImageUpload('profilePhoto', (url) => setupProfile(name, email, url)); } else { setupProfile(name, email, null); }
    };
    window.saveNewContact = function() {
      const name = document.getElementById('contactName').value;
      const photoInput = document.getElementById('contactPhoto');
      if (!name) { alert('Please enter contact name'); return; }
      if (photoInput && photoInput.files && photoInput.files[0]) { handleImageUpload('contactPhoto', (url) => addContact(name, url)); } else { addContact(name, null); }
    };
    window.saveProfileEdit = function() {
      const name = document.getElementById('editName').value;
      const email = document.getElementById('editEmail').value;
      const photoInput = document.getElementById('editPhoto');
      if (!name) { alert('Please enter your name'); return; }
      if (!email) { alert('Please enter your email'); return; }
      if (photoInput && photoInput.files && photoInput.files[0]) { handleImageUpload('editPhoto', (url) => updateProfile(name, email, url)); } else { updateProfile(name, email, null); }
    };
    window.handleVoiceCommand = handleVoiceCommand;
    window.removeContact = removeContact;
    window.confirmRemoveContact = confirmRemoveContact;
    window.toggleContactActive = toggleContactActive;
    window.toggleListening = toggleListening;
    window.confirmToggleListening = confirmToggleListening;
    window.simulateIncomingCall = simulateIncomingCall;
    window.acceptCall = acceptCall;
    window.declineCall = declineCall;
    window.endCall = endCall;
    window.toggleSetting = toggleSetting;
    window.sendInvite = sendInvite;
    render();
  </script>
</body>
</html>
