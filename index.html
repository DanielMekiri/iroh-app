<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hori - Voice Call App</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      overscroll-behavior: none;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-purple-600 to-blue-600 min-h-screen">
  <div id="app"></div>

  <script>
    // App State
    let state = {
      screen: 'contacts',
      contacts: JSON.parse(localStorage.getItem('hori_contacts') || '[]'),
      isListening: false,
      isMuted: false,
      isSpeakerOn: true,
      currentCall: null,
      incomingCall: null,
      incomingAudio: null,
      settings: JSON.parse(localStorage.getItem('hori_settings') || '{"notifyOnSilent":true}'),
      showAddContact: false,
      newContact: { name: '', voiceName: '' }
    };

    let recognition = null;
    let mediaRecorder = null;
    let audioChunks = [];
    let isRecordingVoiceTrigger = false;

    // Initialize Speech Recognition
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.continuous = true;
      recognition.interimResults = true;

      recognition.onresult = (event) => {
        const last = event.results.length - 1;
        const text = event.results[last][0].transcript.toLowerCase().trim();
        handleVoiceCommand(text);
      };

      recognition.onerror = (event) => {
        console.error('Speech recognition error:', event.error);
      };
    }

    // Voice Command Handler
    function handleVoiceCommand(text) {
      if ((text.includes('love you') || text.includes('love ya')) && state.currentCall) {
        endCall();
        return;
      }

      if (text.includes('yes') && state.incomingCall) {
        acceptCall();
        return;
      }

      if (state.screen === 'contacts' && !state.currentCall && !isRecordingVoiceTrigger) {
        const matchedContact = state.contacts.find(c => 
          text.includes(c.voiceName.toLowerCase())
        );
        if (matchedContact) {
          startRecordingForCall(matchedContact);
        }
      }
    }

    async function startRecordingForCall(contact) {
      try {
        isRecordingVoiceTrigger = true;
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];

        mediaRecorder.ondataavailable = (event) => {
          if (event.data.size > 0) {
            audioChunks.push(event.data);
          }
        };

        mediaRecorder.onstop = () => {
          const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
          const audioUrl = URL.createObjectURL(audioBlob);
          stream.getTracks().forEach(track => track.stop());
          
          initiateCall(contact, audioUrl);
          isRecordingVoiceTrigger = false;
        };

        mediaRecorder.start();
        
        setTimeout(() => {
          if (mediaRecorder && mediaRecorder.state === 'recording') {
            mediaRecorder.stop();
          }
        }, 2000);
      } catch (error) {
        console.error('Recording error:', error);
        alert('Could not access microphone: ' + error.message);
        isRecordingVoiceTrigger = false;
      }
    }

    function toggleListening() {
      state.isListening = !state.isListening;
      
      if (state.isListening && recognition) {
        try {
          recognition.start();
        } catch (e) {
          console.log('Recognition already started');
        }
      } else if (recognition) {
        try {
          recognition.stop();
        } catch (e) {
          console.log('Recognition already stopped');
        }
      }
      render();
    }

    function showAddContactForm() {
      state.showAddContact = true;
      state.newContact = { name: '', voiceName: '' };
      render();
    }

    function saveContact() {
      if (state.newContact.name && state.newContact.voiceName) {
        state.contacts.push({
          id: Date.now(),
          name: state.newContact.name,
          voiceName: state.newContact.voiceName
        });
        localStorage.setItem('hori_contacts', JSON.stringify(state.contacts));
        state.showAddContact = false;
        render();
      }
    }

    function removeContact(id) {
      state.contacts = state.contacts.filter(c => c.id !== id);
      localStorage.setItem('hori_contacts', JSON.stringify(state.contacts));
      render();
    }

    function initiateCall(contact, notificationAudio) {
      state.currentCall = contact;
      state.screen = 'call';
      state.isSpeakerOn = true;
      state.isListening = true;
      
      if (recognition && state.isListening) {
        try {
          recognition.start();
        } catch (e) {}
      }
      
      render();
    }

    function simulateIncomingCall(contact) {
      state.incomingCall = contact;
      state.screen = 'incoming';
      state.isListening = true;
      
      const utterance = new SpeechSynthesisUtterance(contact.voiceName);
      utterance.rate = 0.9;
      speechSynthesis.speak(utterance);
      
      if (recognition) {
        try {
          recognition.start();
        } catch (e) {}
      }
      
      render();
    }

    function acceptCall() {
      state.currentCall = state.incomingCall;
      state.incomingCall = null;
      state.screen = 'call';
      state.isSpeakerOn = true;
      render();
    }

    function declineCall() {
      state.incomingCall = null;
      state.screen = 'contacts';
      state.isListening = false;
      if (recognition) {
        try {
          recognition.stop();
        } catch (e) {}
      }
      render();
    }

    function endCall() {
      state.currentCall = null;
      state.screen = 'contacts';
      state.isMuted = false;
      state.isSpeakerOn = true;
      state.isListening = false;
      if (recognition) {
        try {
          recognition.stop();
        } catch (e) {}
      }
      render();
    }

    function toggleSetting(key) {
      state.settings[key] = !state.settings[key];
      localStorage.setItem('hori_settings', JSON.stringify(state.settings));
      render();
    }

    function renderContacts() {
      return `
        <div class="max-w-md mx-auto p-6">
          <div class="flex items-center justify-between mb-8">
            <h1 class="text-4xl font-bold text-white">Hori</h1>
            <button onclick="changeScreen('settings')" class="p-2 hover:bg-white/10 rounded-full transition text-white">
              ‚öôÔ∏è
            </button>
          </div>

          <div class="bg-white/10 backdrop-blur rounded-2xl p-4 mb-4">
            <div class="flex items-center justify-between mb-2">
              <span class="text-sm text-white opacity-75">Voice Control</span>
              <button
                onclick="toggleListening()"
                class="p-2 rounded-full transition ${state.isListening ? 'bg-green-500' : 'bg-white/20'}"
              >
                üé§
              </button>
            </div>
            ${state.isListening ? '<div class="text-xs bg-black/20 rounded-lg p-2 mt-2 text-white">Listening... Say a contact name to call</div>' : ''}
          </div>

          <div class="mb-4">
            <div class="flex items-center justify-between mb-3">
              <h2 class="text-xl font-semibold text-white">VIP Contacts</h2>
              <button
                onclick="showAddContactForm()"
                class="p-2 bg-white/20 hover:bg-white/30 rounded-full transition text-white"
              >
                ‚ûï
              </button>
            </div>

            ${state.contacts.length === 0 ? `
              <div class="bg-white/10 backdrop-blur rounded-xl p-8 text-center text-white">
                <p class="opacity-75">No VIP contacts yet</p>
                <p class="text-sm opacity-50 mt-2">Add someone special to call</p>
              </div>
            ` : `
              <div class="space-y-3">
                ${state.contacts.map(contact => `
                  <div class="bg-white/10 backdrop-blur rounded-xl p-4 flex items-center justify-between">
                    <div class="flex-1">
                      <h3 class="font-semibold text-lg text-white">${contact.name}</h3>
                      <p class="text-sm text-white opacity-75">Say: "${contact.voiceName}"</p>
                    </div>
                    <div class="flex gap-2">
                      <button
                        onclick='manualCall(${JSON.stringify(contact)})'
                        class="p-3 bg-green-500 hover:bg-green-600 rounded-full transition"
                      >
                        üìû
                      </button>
                      <button
                        onclick="removeContact(${contact.id})"
                        class="p-3 bg-red-500/50 hover:bg-red-500 rounded-full transition"
                      >
                        ‚ùå
                      </button>
                    </div>
                  </div>
                `).join('')}
              </div>
            `}
          </div>

          ${state.contacts.length > 0 ? `
            <button
              onclick='simulateIncomingCall(${JSON.stringify(state.contacts[0])})'
              class="w-full bg-white/10 hover:bg-white/20 rounded-xl p-3 text-sm transition text-white"
            >
              üì≤ Simulate Incoming Call (Demo)
            </button>
          ` : ''}
        </div>

        ${state.showAddContact ? renderAddContactModal() : ''}
      `;
    }

    function renderAddContactModal() {
      return `
        <div class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-6 z-50">
          <div class="bg-white text-gray-900 rounded-2xl p-6 max-w-sm w-full">
            <h2 class="text-2xl font-bold mb-4">Add VIP Contact</h2>
            
            <input
              type="text"
              id="contactName"
              placeholder="Contact Name"
              value="${state.newContact.name}"
              class="w-full p-3 border rounded-lg mb-3"
            />
            
            <input
              type="text"
              id="voiceName"
              placeholder="Voice Name (how you'll say it)"
              value="${state.newContact.voiceName}"
              class="w-full p-3 border rounded-lg mb-4"
            />

            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4 text-sm">
              <p class="font-semibold text-blue-900 mb-1">üí° How it works:</p>
              <p class="text-blue-700">When you say their voice name, your phone will record that audio and send it as their notification!</p>
            </div>

            <div class="flex gap-2">
              <button
                onclick="state.showAddContact = false; render();"
                class="flex-1 p-3 bg-gray-200 rounded-lg"
              >
                Cancel
              </button>
              <button
                onclick="saveContact()"
                class="flex-1 p-3 bg-purple-600 text-white rounded-lg"
              >
                Add Contact
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function renderIncoming() {
      return `
        <div class="min-h-screen flex items-center justify-center p-6">
          <div class="text-center max-w-sm text-white">
            <div class="mb-8">
              <div class="w-32 h-32 bg-white/20 rounded-full mx-auto mb-4 flex items-center justify-center animate-pulse text-6xl">
                üìû
              </div>
              <h2 class="text-3xl font-bold mb-2">${state.incomingCall?.name}</h2>
              <p class="text-xl opacity-75">is calling you...</p>
            </div>

            <div class="bg-white/10 backdrop-blur rounded-xl p-4 mb-6">
              <p class="text-sm mb-2">Say "yes" to answer</p>
            </div>

            <div class="flex gap-4 justify-center">
              <button
                onclick="declineCall()"
                class="p-6 bg-red-500 hover:bg-red-600 rounded-full transition text-3xl"
              >
                ‚ùå
              </button>
              <button
                onclick="acceptCall()"
                class="p-6 bg-green-500 hover:bg-green-600 rounded-full transition text-3xl"
              >
                ‚úÖ
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function renderCall() {
      return `
        <div class="min-h-screen flex flex-col items-center justify-between p-6">
          <div class="text-center mt-16 text-white">
            <div class="w-32 h-32 bg-white/20 rounded-full mx-auto mb-4 flex items-center justify-center text-6xl">
              üìû
            </div>
            <h2 class="text-3xl font-bold mb-2">${state.currentCall?.name}</h2>
            <p class="text-xl opacity-75">Connected</p>
          </div>

          <div class="w-full max-w-sm">
            <div class="bg-white/10 backdrop-blur rounded-xl p-4 mb-6 text-white">
              <p class="text-sm mb-2 text-center">Say "love you" to end call</p>
            </div>

            <div class="flex gap-4 justify-center mb-8">
              <button
                onclick="state.isMuted = !state.isMuted; render();"
                class="p-6 rounded-full transition text-3xl ${state.isMuted ? 'bg-red-500' : 'bg-white/20 hover:bg-white/30'}"
              >
                ${state.isMuted ? 'üîá' : 'üé§'}
              </button>
              <button
                onclick="state.isSpeakerOn = !state.isSpeakerOn; render();"
                class="p-6 rounded-full transition text-3xl ${state.isSpeakerOn ? 'bg-white/20 hover:bg-white/30' : 'bg-white/10'}"
              >
                ${state.isSpeakerOn ? 'üîä' : 'üîà'}
              </button>
            </div>

            <button
              onclick="endCall()"
              class="w-full p-4 bg-red-500 hover:bg-red-600 rounded-full transition flex items-center justify-center gap-2 text-white font-semibold"
            >
              ‚ùå End Call
            </button>
          </div>
        </div>
      `;
    }

    function renderSettings() {
      return `
        <div class="max-w-md mx-auto p-6">
          <div class="flex items-center mb-8 text-white">
            <button
              onclick="changeScreen('contacts')"
              class="p-2 hover:bg-white/10 rounded-full transition mr-4"
            >
              ‚¨ÖÔ∏è
            </button>
            <h1 class="text-3xl font-bold">Settings</h1>
          </div>

          <div class="space-y-4">
            <div class="bg-white/10 backdrop-blur rounded-xl p-4">
              <div class="flex items-center justify-between text-white">
                <div>
                  <h3 class="font-semibold mb-1">Notify on Silent</h3>
                  <p class="text-sm opacity-75">Hear calls even when phone is silent</p>
                </div>
                <button
                  onclick="toggleSetting('notifyOnSilent')"
                  class="w-12 h-6 rounded-full transition ${state.settings.notifyOnSilent ? 'bg-green-500' : 'bg-gray-600'}"
                >
                  <div class="w-5 h-5 bg-white rounded-full transition transform ${state.settings.notifyOnSilent ? 'translate-x-6' : 'translate-x-1'}"></div>
                </button>
              </div>
            </div>

            <div class="bg-white/10 backdrop-blur rounded-xl p-4 text-white">
              <h3 class="font-semibold mb-2">About Hori</h3>
              <p class="text-sm opacity-75">Voice-first calling for your VIPs</p>
              <p class="text-xs opacity-50 mt-2">Version 1.0 - Prototype</p>
              <p class="text-xs opacity-75 mt-3">üí° When you say a contact's name, Hori records that audio and sends it as their call notification - so they hear YOU calling their name!</p>
            </div>
          </div>
        </div>
      `;
    }

    function render() {
      const app = document.getElementById('app');
      let html = '';

      switch (state.screen) {
        case 'contacts':
          html = renderContacts();
          break;
        case 'incoming':
          html = renderIncoming();
          break;
        case 'call':
          html = renderCall();
          break;
        case 'settings':
          html = renderSettings();
          break;
      }

      app.innerHTML = html;

      if (state.showAddContact) {
        const nameInput = document.getElementById('contactName');
        const voiceInput = document.getElementById('voiceName');
        if (nameInput) {
          nameInput.value = state.newContact.name;
          nameInput.oninput = (e) => { state.newContact.name = e.target.value; };
        }
        if (voiceInput) {
          voiceInput.value = state.newContact.voiceName;
          voiceInput.oninput = (e) => { state.newContact.voiceName = e.target.value; };
        }
      }
    }

    function changeScreen(screen) {
      state.screen = screen;
      render();
    }

    function manualCall(contact) {
      startRecordingForCall(contact);
    }

    render();
  </script>
</body>
</html>